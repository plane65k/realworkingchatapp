<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatify</title>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.0/dist/umd/supabase.min.js"></script>
<style>
:root {
  --background-color: #f5f5f5;
  --text-color: #333333;
  --card-background: #ffffff;
  --button-background: #4caf50;
  --button-text: #ffffff;
  --secondary-background: #fafafa;
  --border-color: #ccc;
  --shadow-color: rgba(0,0,0,0.2);
  --message-my-background: #4caf50;
  --message-my-text: #ffffff;
  --message-other-background: #e0e0e0;
  --message-other-text: #000000;
  --overlay-background: rgba(0,0,0,0.4);
  --transition-time: 2s;
}
[data-theme="dark"] {
  --background-color: #1a1a1a;
  --text-color: #ffffff;
  --card-background: #2c2c2c;
  --button-background: #45a049;
  --button-text: #ffffff;
  --secondary-background: #333333;
  --border-color: #555555;
  --shadow-color: rgba(255,255,255,0.1);
  --message-my-background: #45a049;
  --message-my-text: #ffffff;
  --message-other-background: #4a4a4a;
  --message-other-text: #ffffff;
  --overlay-background: rgba(255,255,255,0.2);
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
  background:var(--background-color);
  color:var(--text-color);
  transition:background-color var(--transition-time) ease,color var(--transition-time) ease;
  display: flex;
  flex-direction: column;
}

/* PIN overlay */
#pinOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--overlay-background);
  z-index:100;
}
#pinBox{
  background:var(--card-background);
  padding:30px;
  border-radius:16px;
  width:320px;
  box-shadow:0 8px 30px var(--shadow-color)
}
#pinBox input{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border-color);
  width:100%;
  margin-bottom:10px;
  background:transparent;
  color:var(--text-color)
}
#pinBox button{
  background:var(--button-background);
  color:var(--button-text);
  padding:12px;
  border-radius:12px;
  border:0;
  width:100%;
  cursor:pointer;
  font-weight:700
}

/* Chat App */
#chatApp{
  display:none;
  width:100%;
  height:100vh;
  background:var(--card-background);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  transition:background-color var(--transition-time)
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  background:var(--button-background);
  color:var(--button-text);
  font-weight:700;
  flex-shrink: 0;
}
.header-actions{
  display:flex;
  gap:10px;
  align-items:center
}
.button-clear{
  background:none;
  border:none;
  color:var(--button-text);
  cursor:pointer;
  font-weight:600
}
#loading{
  display:none;
  padding:18px;
  align-items:center;
  justify-content:center;
  flex-shrink: 0;
}
.loader{
  border:6px solid var(--secondary-background);
  border-top:6px solid var(--button-background);
  border-radius:50%;
  width:36px;
  height:36px;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

#chat{
  flex:1;
  overflow:auto;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:var(--secondary-background)
}
.message{
  max-width:72%;
  padding:12px 14px;
  border-radius:14px;
  font-size:14px;
  position:relative;
  word-break:break-word;
  transition:transform .18s,opacity .18s
}
.myMessage{
  align-self:flex-end;
  background:var(--message-my-background);
  color:var(--message-my-text);
  border-bottom-right-radius:6px
}
.otherMessage{
  align-self:flex-start;
  background:var(--message-other-background);
  color:var(--message-other-text);
  border-bottom-left-radius:6px
}
.timestamp{
  display:block;
  font-size:11px;
  color:var(--border-color);
  margin-top:6px
}
.options{
  position:absolute;
  top:6px;
  right:8px;
  cursor:pointer
}
.options-menu{
  position:absolute;
  top:26px;
  right:8px;
  background:var(--card-background);
  border:1px solid var(--border-color);
  border-radius:8px;
  padding:6px;
  display:none;
  box-shadow:0 8px 20px var(--shadow-color)
}
.options-menu button{
  display:block;
  background:none;
  border:none;
  padding:6px 10px;
  width:100%;
  text-align:left;
  cursor:pointer;
  color:var(--text-color);
  border-radius:6px
}
.options-menu button:hover{
  background:var(--secondary-background)
}

footer{
  display:flex;
  padding:12px;
  border-top:1px solid var(--border-color);
  background:var(--card-background);
  flex-shrink: 0;
}
footer input{
  flex:1;
  padding:12px;
  border-radius:24px;
  border:1px solid var(--border-color);
  margin-right:10px;
  background:transparent;
  color:var(--text-color)
}
footer button{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:var(--button-background);
  color:var(--button-text);
  font-size:18px;
  cursor:pointer
}

/* Admin modal */
.admin-panel-btn{
  background:rgba(255,255,255,0.12);
  border:none;
  color:var(--button-text);
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer
}
.admin-modal{
  position:fixed;
  right:18px;
  top:18px;
  width:320px;
  background:var(--card-background);
  border:1px solid var(--border-color);
  box-shadow:0 12px 30px var(--shadow-color);
  border-radius:12px;
  padding:12px;
  z-index:120;
  display:none
}
.admin-modal h3{
  margin:0 0 8px 0
}
.control-row{
  display:flex;
  gap:8px;
  margin-bottom:8px
}
.control-row input, .control-row select{
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border-color);
  background:transparent;
  color:var(--text-color)
}
.control-row button{
  padding:8px 10px;
  border-radius:8px;
  border:0;
  background:var(--button-background);
  color:var(--button-text);
  cursor:pointer
}

/* notification banner */
.notify-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:18px;
  background:linear-gradient(90deg,var(--button-background),#2e7d32);
  color:var(--button-text);
  padding:12px 18px;
  border-radius:999px;
  box-shadow:0 12px 30px var(--shadow-color);
  z-index:200;
  display:none;
  animation:bannerIn .35s ease
}
@keyframes bannerIn{
  from{opacity:0;transform:translate(-50%,-6px)}
  to{opacity:1;transform:translate(-50%,0)}
}

a{color:#0a66c2;text-decoration:underline}
</style>
</head>
<body>

<!-- PIN overlay -->
<div id="pinOverlay" aria-hidden="false">
  <div id="pinBox">
    <input id="usernameInput" placeholder="Enter username" autocomplete="off" />
    <input id="pinInput" placeholder="Enter PIN" type="password" autocomplete="current-password" />
    <button id="pinBtn">Enter Chat</button>
  </div>
</div>

<div id="chatApp" aria-hidden="true">
  <header>
    <div>Chatify</div>
    <div class="header-actions">
      <button id="toggleThemeBtn" class="button-clear" title="Toggle theme">Toggle Theme</button>
      <button id="adminBtn" class="admin-panel-btn" style="display:none">Admin</button>
      <button id="signoutBtn" class="button-clear" title="Sign out" style="color:salmon">Sign out</button>
    </div>
  </header>

  <div id="loading"><div class="loader"></div></div>
  <div id="chat" role="log" aria-live="polite"></div>

  <footer>
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">➤</button>
  </footer>
</div>

<!-- Admin modal -->
<div id="adminModal" class="admin-modal" role="dialog" aria-hidden="true">
  <h3>Admin Control Center</h3>
  <div style="font-size:13px;margin-bottom:8px;color:var(--text-color)">Root controls</div>

  <div class="control-row">
    <input id="delId" placeholder="message id to delete" />
    <button id="delByIdBtn">Delete</button>
  </div>

  <div class="control-row">
    <button id="deleteAllBtn">Delete All Messages</button>
  </div>

  <div class="control-row">
    <input id="editId" placeholder="message id to edit timestamp" />
    <input id="editTimestamp" placeholder="new timestamp (e.g. 3:25 PM)" />
    <button id="editTsBtn">Edit TS</button>
  </div>

  <div class="control-row">
    <input id="banUserInput" placeholder="username to ban/unban" />
    <button id="banBtn">Ban</button>
    <button id="unbanBtn">Unban</button>
  </div>

  <div class="control-row">
    <input id="notifyText" placeholder="notification text" />
    <button id="notifyBtn">Notify</button>
  </div>

  <div style="font-size:12px;color:#6b7280;margin-top:8px">Admin user: <strong>root</strong> — Admin PIN: <strong>qwery</strong></div>
</div>

<div id="notifyBanner" class="notify-banner"></div>

<audio id="newMessageSound" src="https://www.soundjay.com/button/sounds/button-3.mp3" preload="auto"></audio>
<script>
/* ==== Config ==== */
const ADMIN_USERNAME = 'root';
const ADMIN_PIN = 'qwery';
const PIN_CODE = '5432'; // regular pin

/* ==== Supabase Configuration ==== */
const SUPABASE_URL = "https://kqbylnsogapepslmxtwv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxYnlsbnNvZ2FwZXBzbG14dHd2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDYzNDkwMywiZXhwIjoyMDc2MjEwOTAzfQ.wCMSO-UuZtBbpJzEUKx8nz5MGtnx7aJBWEIozC9a6dM";
const TABLE = "messages"; // public.messages

/* ==== Supabase Instance ==== */
let supabase = null;
let realtimeSubscription = null;

/* ==== Elements ==== */
const pinOverlay = document.getElementById('pinOverlay');
const usernameInput = document.getElementById('usernameInput');
const pinInput = document.getElementById('pinInput');
const pinBtn = document.getElementById('pinBtn');
const chatApp = document.getElementById('chatApp');
const chatDiv = document.getElementById('chat');
const loadingDiv = document.getElementById('loading');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const adminBtn = document.getElementById('adminBtn');
const adminModal = document.getElementById('adminModal');
const notifyBanner = document.getElementById('notifyBanner');
const newMessageSound = document.getElementById('newMessageSound');
const toggleThemeBtn = document.getElementById('toggleThemeBtn');
const signoutBtn = document.getElementById('signoutBtn');

/* Admin controls */
const delIdInput = document.getElementById('delId');
const delByIdBtn = document.getElementById('delByIdBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const editIdInput = document.getElementById('editId');
const editTsInput = document.getElementById('editTimestamp');
const editTsBtn = document.getElementById('editTsBtn');
const banUserInput = document.getElementById('banUserInput');
const banBtn = document.getElementById('banBtn');
const unbanBtn = document.getElementById('unbanBtn');
const notifyTextInput = document.getElementById('notifyText');
const notifyBtn = document.getElementById('notifyBtn');

/* ==== State ==== */
let currentUser = null;
let messages = [];        // persisted master copy
let displayed = new Set(); // ids rendered
let bannedUsers = new Set();
let isAdmin = false;
let isTabActive = true;
let workingColumn = null; // for dynamic column detection

/* ==== Tab visibility detection ==== */
document.addEventListener('visibilitychange', () => {
  isTabActive = !document.hidden;
});

/* ==== Theme init ==== */
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
document.documentElement.setAttribute('data-theme', savedTheme || (prefersDark ? 'dark' : 'light'));
toggleThemeBtn.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
});

/* ==== Persistence helpers ==== */
function loadLocalState(){
  try{ const raw = localStorage.getItem('chatMessages'); if(raw) messages = JSON.parse(raw); }catch(e){ messages = []; }
  try{ const bu = localStorage.getItem('chatBanned'); if(bu) bannedUsers = new Set(JSON.parse(bu)); }catch(e){ bannedUsers = new Set(); }
}
function saveLocalState(){ localStorage.setItem('chatMessages', JSON.stringify(messages)); localStorage.setItem('chatBanned', JSON.stringify([...bannedUsers])); }

/* ==== Utilities ==== */
function makeId(){ return Date.now() + "-" + Math.random().toString(36).slice(2,9); }
function formatTS(ts){ return ts || new Date().toLocaleTimeString(); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ==== Supabase Column Detection Logic ==== */
async function tryInsertColumn(colName, row) {
  try {
    const r = await supabase
      .from(TABLE)
      .insert([row])
      .select(); // select returns inserted row for verification
    if (r.error) {
      return { ok: false, error: r.error };
    }
    return { ok:true, data: r.data };
  } catch (e) {
    return { ok:false, error: e };
  }
}

async function determineColumnAndSend(username, text) {
  const candidates = ['content','message','text'];
  // if we already discovered workingColumn, use it
  if (workingColumn) {
    return await insertWithColumn(workingColumn, username, text);
  }
  // else try each candidate but safely: use limit 1 test insert then delete it
  for (const col of candidates) {
    console.log(`Trying insert with column "${col}"...`);
    const row = { username, [col]: text };
    const res = await tryInsertColumn(col, row);
    if (res.ok) {
      console.log(`Insert ok with column "${col}". Using it from now on.`);
      workingColumn = col;
      return { ok:true, col, data:res.data };
    } else {
      // Check PostgREST error shape for missing column: PGRST204
      const errObj = res.error;
      console.log(`Insert failed for "${col}":`, errObj);
      // If message contains "Could not find the 'X' column" we continue
      const m = errObj && (errObj.message || errObj.error || JSON.stringify(errObj));
      if (m && m.toString().includes("Could not find the")) {
        // try next
        continue;
      } else {
        // unknown error (for example, CORS, network, 403)
        return { ok:false, error: errObj };
      }
    }
  }
  return { ok:false, error: "No writable text column found among candidates: content,message,text" };
}

async function insertWithColumn(col, username, text) {
  try {
    const row = { username, [col]: text };
    const r = await supabase.from(TABLE).insert([row]).select();
    if (r.error) {
      return { ok:false, error:r.error };
    }
    return { ok:true, data: r.data, col };
  } catch (e) {
    return { ok:false, error:e };
  }
}

/* ==== Render ==== */
function clearChatAndRenderAll(){
  chatDiv.innerHTML = '';
  displayed.clear();
  for(const m of messages){ renderOneMessage(m,false); }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
function renderOneMessage(msg, live=false){
  if(displayed.has(msg.id)) return;
  displayed.add(msg.id);
  const isBanned = bannedUsers.has(msg.username);
  const el = document.createElement('div');
  el.className = 'message ' + (msg.username === (currentUser && currentUser.username) ? 'myMessage' : 'otherMessage');
  el.dataset.id = msg.id;

  const content = msg.deleted ? "<em>Message deleted</em>" :
    (msg.message && msg.message.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i) ? `<img src="${escapeHtml(msg.message)}" style="max-width:260px;border-radius:8px" />` :
      (msg.message && msg.message.match(/^https?:\/\//i) ? `<a href="${escapeHtml(msg.message)}" target="_blank" rel="noreferrer">${escapeHtml(msg.message)}</a>` :
       escapeHtml(msg.message || '')));

  const bannedNote = isBanned ? `<div style="font-size:12px;color:#bf3b3b;margin-bottom:6px">[BANNED USER]</div>` : '';
  el.innerHTML = `<div>${bannedNote}<strong>${escapeHtml(msg.username)}</strong>: ${content}</div><div class="timestamp">${escapeHtml(msg.timestamp || '')}</div>`;

  // If admin or message owner, show options menu; admin can delete any message, owner can delete own
  if((isAdmin) || (currentUser && msg.username === currentUser.username && !msg.deleted)){
    const opt = document.createElement('div'); opt.className = 'options'; opt.textContent = '⋮';
    const menu = document.createElement('div'); menu.className = 'options-menu';
    // Delete action (admin or owner)
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete';
    delBtn.onclick = () => {
      const idx = messages.findIndex(m=>m.id===msg.id);
      if(idx>=0){ messages[idx].deleted = true; saveLocalState(); }
      // Delete from Supabase
      deleteMessage(msg.id);
      menu.style.display='none';
      clearChatAndRenderAll();
    };
    menu.appendChild(delBtn);
    // If admin, edit timestamp and force-delete option
    if(isAdmin){
      const editBtn = document.createElement('button'); editBtn.textContent = 'Edit timestamp';
      editBtn.onclick = () => {
        const newTs = prompt('Enter new timestamp (e.g. 3:25 PM):', msg.timestamp || '');
        if(newTs != null){
          const idx = messages.findIndex(m=>m.id===msg.id);
          if(idx>=0){ messages[idx].timestamp = newTs; saveLocalState(); }
          // Update in Supabase
          updateMessageTimestamp(msg.id, newTs);
          clearChatAndRenderAll();
        }
        menu.style.display='none';
      };
      menu.appendChild(editBtn);
      const forceDelBtn = document.createElement('button'); forceDelBtn.textContent = 'Force delete (admin)';
      forceDelBtn.onclick = () => {
        if(!confirm('Confirm force delete this message for all users?')) return;
        const idx = messages.findIndex(m=>m.id===msg.id);
        if(idx>=0){ messages[idx].deleted = true; saveLocalState(); }
        // Delete from Supabase
        deleteMessage(msg.id);
        clearChatAndRenderAll();
        menu.style.display='none';
      };
      menu.appendChild(forceDelBtn);
    }
    opt.onclick = ()=> menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    el.appendChild(opt);
    el.appendChild(menu);
  }

  chatDiv.appendChild(el);
  if(live && currentUser && msg.username !== currentUser.username && !msg.deleted){
    // Only show notifications if tab is not active
    if (!isTabActive) {
      if(msg.message && msg.message.includes('@' + currentUser.username)){
        alert(`Mentioned: ${msg.username}: ${msg.message}`);
      } else {
        alert(`New message from ${msg.username}: ${msg.message}`);
      }
      newMessageSound.play();
    }
  }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

/* ==== Supabase Functions ==== */
function initializeSupabase() {
  try {
    if (!window.supabase) {
      console.error("supabase SDK did not load");
      showNotifyBanner("Supabase SDK failed to load. Check network.");
      return;
    }
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Load recent messages and subscribe to realtime updates
    fetchRecent().then(() => subscribeRealtime()).catch(e => console.error(e));
  } catch (error) {
    console.error('Error initializing Supabase:', error);
    showNotifyBanner('Error connecting to database');
  }
}

async function fetchRecent(){
  loadingDiv.style.display = 'flex';
  try {
    // Try to select these columns (if they don't exist it may error).
    let selectCols = 'id, username, content, message, text, created_at';
    let r = await supabase.from(TABLE).select(selectCols).order('created_at',{ascending:true}).limit(300);
    if (r.error) {
      // fallback to plain select *
      console.log('Select with candidate columns failed, trying select * — error:', r.error);
      r = await supabase.from(TABLE).select('*').order('created_at',{ascending:true}).limit(300);
    }
    if (r.error) {
      console.error('Fetch failed:', r.error);
      showNotifyBanner('Fetch failed: ' + (r.error.message || JSON.stringify(r.error)));
      return;
    }
    
    // Process fetched messages
    messages = r.data.map(m => {
      const text = m.content || m.message || m.text || '';
      return {
        id: m.id,
        username: m.username || 'anon',
        message: text,
        timestamp: m.created_at ? new Date(m.created_at).toLocaleTimeString() : '',
        deleted: false
      };
    });
    
    saveLocalState();
    clearChatAndRenderAll();
  } catch (e) {
    console.error('Fetch exception:', e);
    showNotifyBanner('Fetch exception: ' + e.message);
  } finally {
    loadingDiv.style.display = 'none';
  }
}

async function subscribeRealtime() {
  try {
    if (realtimeSubscription) {
      console.log('Realtime already subscribed.');
      return;
    }
    realtimeSubscription = supabase.channel('public:'+TABLE)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: TABLE }, (payload) => {
        console.log('Realtime INSERT:', payload.new);
        // Process new message
        const m = payload.new;
        const text = m.content || m.message || m.text || '';
        const newMessage = {
          id: m.id,
          username: m.username || 'anon',
          message: text,
          timestamp: m.created_at ? new Date(m.created_at).toLocaleTimeString() : '',
          deleted: false
        };
        
        // Add to messages and render
        const idx = messages.findIndex(msg => msg.id === newMessage.id);
        if (idx === -1) {
          messages.push(newMessage);
          saveLocalState();
          renderOneMessage(newMessage, true);
        }
      })
      .subscribe();
    console.log('Realtime subscription created');
  } catch (e) {
    console.error('Realtime subscribe error:', e);
    showNotifyBanner('Realtime subscribe error: ' + (e.message||e));
  }
}

async function deleteMessage(id) {
  try {
    const { error } = await supabase
      .from(TABLE)
      .delete()
      .eq('id', id);
    
    if (error) {
      console.error('Delete error:', error);
      showNotifyBanner('Delete failed: ' + error.message);
    }
  } catch (e) {
    console.error('Delete exception:', e);
    showNotifyBanner('Delete exception: ' + e.message);
  }
}

async function updateMessageTimestamp(id, newTimestamp) {
  try {
    // This would require a timestamp column in your database
    // For now, we'll just update the local state
    console.log('Timestamp update would be implemented here for ID:', id, 'New timestamp:', newTimestamp);
  } catch (e) {
    console.error('Update timestamp error:', e);
    showNotifyBanner('Update timestamp error: ' + e.message);
  }
}

/* ==== Load local state and initial render ==== */
loadLocalState();
if(localStorage.getItem('chatUser')){
  currentUser = JSON.parse(localStorage.getItem('chatUser'));
  // admin check saved
  if(currentUser.username === ADMIN_USERNAME && localStorage.getItem('lastPin') === ADMIN_PIN){
    isAdmin = true;
    adminBtn.style.display = 'inline-block';
  }
  pinOverlay.style.display = 'none';
  chatApp.style.display = 'flex';
  
  // Initialize Supabase after user is loaded
  initializeSupabase();
  
  if(messages.length) messages.forEach(m => renderOneMessage(m,false));
}

/* ==== Send message ==== */
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
async function sendMessage(){
  const text = (messageInput.value || '').trim();
  if(!text || !currentUser) return;
  if(bannedUsers.has(currentUser.username)){
    showNotifyBanner('You are banned from sending messages.');
    return;
  }
  
  // determine writable column if needed
  const result = await determineColumnAndSend(currentUser.username, text);
  if (!result.ok) {
    showNotifyBanner('Send failed: ' + (result.error && result.error.message ? result.error.message : JSON.stringify(result.error)));
    console.error('Detailed send error:', result.error);
    return;
  }
  
  messageInput.value = '';
}

/* ==== PIN login logic ==== */
pinBtn.addEventListener('click', ()=> {
  const username = (usernameInput.value || '').trim();
  const pin = (pinInput.value || '').trim();
  if(!username) return;
  // set user
  currentUser = { username };
  localStorage.setItem('chatUser', JSON.stringify(currentUser));
  // admin check
  if(username === ADMIN_USERNAME && pin === ADMIN_PIN){
    isAdmin = true;
    adminBtn.style.display = 'inline-block';
    localStorage.setItem('lastPin', ADMIN_PIN);
  } else {
    isAdmin = false;
    adminBtn.style.display = 'none';
    // save lastPin only for admin
    localStorage.removeItem('lastPin');
  }
  // regular pin check required to enter
  const allowedPin = (username === ADMIN_USERNAME && pin === ADMIN_PIN) ? ADMIN_PIN : PIN_CODE;
  if(pin !== allowedPin) {
    alert('Wrong PIN'); // minimal feedback
    // clear credentials saved if wrong
    localStorage.removeItem('chatUser');
    currentUser = null;
    return;
  }
  // proceed
  pinOverlay.style.display = 'none';
  chatApp.style.display = 'flex';
  
  // Initialize Supabase and load messages
  initializeSupabase();
  loadLocalState();
  if(messages.length) clearChatAndRenderAll();
});

/* ==== Admin modal toggle ==== */
adminBtn.addEventListener('click', ()=> {
  adminModal.style.display = adminModal.style.display === 'block' ? 'none' : 'block';
  adminModal.setAttribute('aria-hidden', adminModal.style.display === 'none');
});

/* ==== Admin actions ==== */
// delete by id
delByIdBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const id = (delIdInput.value||'').trim();
  if(!id) return showNotifyBanner('Provide id to delete.');
  const idx = messages.findIndex(m=>m.id===id);
  if(idx === -1) return showNotifyBanner('Message id not found.');
  messages[idx].deleted = true;
  saveLocalState();
  deleteMessage(id);
  clearChatAndRenderAll();
  showNotifyBanner('Message deleted.');
});
// delete all
deleteAllBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  if(!confirm('Confirm delete all messages for everyone?')) return;
  for(const msg of messages){ 
    msg.deleted = true; 
    deleteMessage(msg.id);
  }
  saveLocalState();
  clearChatAndRenderAll();
  showNotifyBanner('All messages deleted.');
});
// edit timestamp
editTsBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const id = (editIdInput.value||'').trim();
  const newTs = (editTsInput.value||'').trim();
  if(!id || !newTs) return showNotifyBanner('Provide id and new timestamp.');
  const idx = messages.findIndex(m=>m.id===id);
  if(idx === -1) return showNotifyBanner('Message id not found.');
  messages[idx].timestamp = newTs;
  saveLocalState();
  updateMessageTimestamp(id, newTs);
  clearChatAndRenderAll();
  showNotifyBanner('Timestamp updated.');
});
// ban/unban
banBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const t = (banUserInput.value||'').trim();
  if(!t) return showNotifyBanner('Provide username to ban.');
  bannedUsers.add(t);
  saveLocalState();
  showNotifyBanner(`User ${t} banned.`);
});
unbanBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const t = (banUserInput.value||'').trim();
  if(!t) return showNotifyBanner('Provide username to unban.');
  bannedUsers.delete(t);
  saveLocalState();
  showNotifyBanner(`User ${t} unbanned.`);
});
// notify
notifyBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const txt = (notifyTextInput.value||'').trim();
  if(!txt) return showNotifyBanner('Provide notification text.');
  showNotifyBanner(txt);
});

/* ==== Notifications (animated banner) ==== */
let bannerTimer = null;
function showNotifyBanner(text){
  notifyBanner.textContent = text;
  notifyBanner.style.display = 'block';
  if(bannerTimer) clearTimeout(bannerTimer);
  bannerTimer = setTimeout(()=> notifyBanner.style.display = 'none', 9000);
}

/* ==== Other UI controls ==== */
signoutBtn.addEventListener('click', ()=> { 
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }
  localStorage.removeItem('chatUser'); 
  localStorage.removeItem('lastPin'); 
  location.reload(); 
});

/* ==== Before unload: cleanup ==== */
window.addEventListener('beforeunload', ()=> {
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }
});

</script>
</body>
</html>
