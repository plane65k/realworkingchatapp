<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="pageTitle">Chatify</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: 'Poppins', sans-serif;
    background: #f5f5f5;
  }

  .white-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    background: white;
    z-index: 1000;
  }

  .intro {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    gap: 20px;
    z-index: 1001;
  }

  .circle {
    width: 140px;
    height: 140px;
    background: #34a853;
    border-radius: 50%;
    transform: scale(3);
    animation: 
      circleRise 1.02s ease-in-out forwards,
      moveRight 0.24s ease-out 1.01s forwards;
  }

  @keyframes circleRise {
    0% { transform: scale(3); }
    100% { transform: translateX(30%) scale(1); }
  }
  @keyframes moveRight {
    0% { transform: translateX(10%) scale(1); }
    100% { transform: translateX(0px) scale(1); }
  }

  .text {
    font-size: 52px;
    font-weight: 700;
    color: #222;
    letter-spacing: 2px;
    opacity: 0;
    animation: textReveal 0.4s ease-out 0.7s forwards;
  }

  @keyframes textReveal {
    0% { opacity: 0; transform: translateX(-100%); }
    100% { opacity: 1; transform: translateX(0); }
  }

  .skip-box {
    position: fixed;
    bottom: 20px;
    right: 20px;
    font-size: 16px;
    color: #333;
    opacity: 0; /* still hidden by default */
    transition: opacity 0.6s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    z-index: 1001;
  }

  .skip-box.show {
    opacity: 0;
  }

  .skip-box input {
    transform: scale(1.2);
    cursor: pointer;
  }

  .flash {
    animation: flashLogo 1s ease-in-out forwards;
  }

  @keyframes flashLogo {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }
</style>
</head>
<body>

<div class="white-overlay" id="whiteOverlay"></div>

<div class="intro">
  <div class="circle"></div>
  <div class="text" id="chatifyText">Chatify</div>
  <label class="skip-box">
    <input type="checkbox" id="skipNext" disabled> Skip intro next time
  </label>
</div>

<script>
  const intro = document.querySelector(".intro");
  const whiteOverlay = document.getElementById("whiteOverlay");
  const chatifyText = document.getElementById("chatifyText");
  const pageTitle = document.getElementById("pageTitle");

  function playIntro() {
    intro.style.display = "flex";
    whiteOverlay.style.display = "block";

    // Show skip box (optional, still disabled)
    setTimeout(() => document.querySelector(".skip-box").classList.add("show"), 1600);

    // Complete animation + flash, then hide intro & overlay before chat loads
    setTimeout(() => {
      chatifyText.classList.add("flash");
      setTimeout(() => {
        chatifyText.classList.remove("flash");
        intro.style.display = "none";       // hide intro container
        whiteOverlay.style.display = "none"; // hide overlay
      }, 1000);
    }, 2500);
  }

  // Always play animation (skip disabled)
  playIntro();

  // Optional: click page title to replay animation
  pageTitle.addEventListener("click", () => {
    const answer = prompt("Type 'y' and press Enter to replay animation:");
    if (answer && answer.toLowerCase() === 'y') {
      playIntro();
    }
  });
</script>
</body>
</html>




<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatify</title>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.0/dist/umd/supabase.min.js"></script>
<style>
:root {
  --background-color: #f5f5f5;
  --text-color: #333333;
  --card-background: #ffffff;
  --button-background: #4caf50;
  --button-text: #ffffff;
  --secondary-background: #fafafa;
  --border-color: #ccc;
  --shadow-color: rgba(0,0,0,0.2);
  --message-my-background: #4caf50;
  --message-my-text: #ffffff;
  --message-other-background: #e0e0e0;
  --message-other-text: #000000;
  --overlay-background: rgba(0,0,0,0.4);
  --transition-time: 2s;
}
[data-theme="dark"] {
  --background-color: #1a1a1a;
  --text-color: #ffffff;
  --card-background: #2c2c2c;
  --button-background: #45a049;
  --button-text: #ffffff;
  --secondary-background: #333333;
  --border-color: #555555;
  --shadow-color: rgba(255,255,255,0.1);
  --message-my-background: #45a049;
  --message-my-text: #ffffff;
  --message-other-background: #4a4a4a;
  --message-other-text: #ffffff;
  --overlay-background: rgba(255,255,255,0.2);
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
  background:var(--background-color);
  color:var(--text-color);
  transition:background-color var(--transition-time) ease,color var(--transition-time) ease;
  display: flex;
  flex-direction: column;
}

/* PIN overlay */
#pinOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--overlay-background);
  z-index:100;
}
#pinBox{
  background:var(--card-background);
  padding:30px;
  border-radius:16px;
  width:320px;
  box-shadow:0 8px 30px var(--shadow-color)
}
#pinBox input{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border-color);
  width:100%;
  margin-bottom:10px;
  background:transparent;
  color:var(--text-color)
}
#pinBox button{
  background:var(--button-background);
  color:var(--button-text);
  padding:12px;
  border-radius:12px;
  border:0;
  width:100%;
  cursor:pointer;
  font-weight:700
}

/* Chat App */
#chatApp{
  display:none;
  width:100%;
  height:100vh;
  background:var(--card-background);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  transition:background-color var(--transition-time)
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  background:var(--button-background);
  color:var(--button-text);
  font-weight:700;
  flex-shrink: 0;
}
.header-actions{
  display:flex;
  gap:10px;
  align-items:center
}
.button-clear{
  background:none;
  border:none;
  color:var(--button-text);
  cursor:pointer;
  font-weight:600
}
#loading{
  display:none;
  padding:18px;
  align-items:center;
  justify-content:center;
  flex-shrink: 0;
}
.loader{
  border:6px solid var(--secondary-background);
  border-top:6px solid var(--button-background);
  border-radius:50%;
  width:36px;
  height:36px;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

#chat{
  flex:1;
  overflow:auto;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:var(--secondary-background)
}
.message{
  max-width:72%;
  padding:12px 14px;
  border-radius:14px;
  font-size:14px;
  position:relative;
  word-break:break-word;
  transition:transform .18s,opacity .18s;
  display: flex;
  align-items: center;
}
.myMessage{
  align-self:flex-end;
  background:var(--message-my-background);
  color:var(--message-my-text);
  border-bottom-right-radius:6px
}
.otherMessage{
  align-self:flex-start;
  background:var(--message-other-background);
  color:var(--message-other-text);
  border-bottom-left-radius:6px
}
.timestamp{
  display:block;
  font-size:11px;
  color:var(--border-color);
  margin-top:6px
}
.options{
  position:absolute;
  top:6px;
  right:8px;
  cursor:pointer
}
.options-menu{
  position:absolute;
  top:26px;
  right:8px;
  background:var(--card-background);
  border:1px solid var(--border-color);
  border-radius:8px;
  padding:6px;
  display:none;
  box-shadow:0 8px 20px var(--shadow-color)
}
.options-menu button{
  display:block;
  background:none;
  border:none;
  padding:6px 10px;
  width:100%;
  text-align:left;
  cursor:pointer;
  color:var(--text-color);
  border-radius:6px
}
.options-menu button:hover{
  background:var(--secondary-background)
}

footer{
  display:flex;
  padding:12px;
  border-top:1px solid var(--border-color);
  background:var(--card-background);
  flex-shrink: 0;
}
footer input{
  flex:1;
  padding:12px;
  border-radius:24px;
  border:1px solid var(--border-color);
  margin-right:10px;
  background:transparent;
  color:var(--text-color)
}
footer button{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:var(--button-background);
  color:var(--button-text);
  font-size:18px;
  cursor:pointer
}

/* Admin modal */
.admin-panel-btn{
  background:rgba(255,255,255,0.12);
  border:none;
  color:var(--button-text);
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer
}
.admin-modal{
  position:fixed;
  right:18px;
  top:18px;
  width:320px;
  background:var(--card-background);
  border:1px solid var(--border-color);
  box-shadow:0 12px 30px var(--shadow-color);
  border-radius:12px;
  padding:12px;
  z-index:120;
  display:none
}
.admin-modal h3{
  margin:0 0 8px 0
}
.control-row{
  display:flex;
  gap:8px;
  margin-bottom:8px
}
.control-row input, .control-row select{
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border-color);
  background:transparent;
  color:var(--text-color)
}
.control-row button{
  padding:8px 10px;
  border-radius:8px;
  border:0;
  background:var(--button-background);
  color:var(--button-text);
  cursor:pointer
}

/* Profile modal */
.profile-modal{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: var(--overlay-background);
  z-index: 110;
}
.profile-modal-content{
  background: var(--card-background);
  padding: 20px;
  border-radius: 16px;
  width: 320px;
  box-shadow: 0 8px 30px var(--shadow-color);
  text-align: center;
}
.profile-preview{
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin: 10px auto;
  display: block;
}
.profile-input-container{
  margin: 10px 0;
}
.profile-input-container input{
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  background: transparent;
  color: var(--text-color);
}
.profile-modal-actions{
  display: flex;
  gap: 10px;
  justify-content: center;
}
.profile-modal-actions button{
  padding: 8px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}
.profile-modal-actions button:first-child{
  background: #ccc;
  color: #333;
}
.profile-modal-actions button:last-child{
  background: var(--button-background);
  color: var(--button-text);
}

/* notification banner */
.notify-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:18px;
  background:linear-gradient(90deg,var(--button-background),#2e7d32);
  color:var(--button-text);
  padding:12px 18px;
  border-radius:999px;
  box-shadow:0 12px 30px var(--shadow-color);
  z-index:200;
  display:none;
  animation:bannerIn .35s ease
}
@keyframes bannerIn{
  from{opacity:0;transform:translate(-50%,-6px)}
  to{opacity:1;transform:translate(-50%,0)}
}

a{color:#0a66c2;text-decoration:underline}
</style>
</head>
<body>

<!-- PIN overlay -->
<div id="pinOverlay" aria-hidden="false">
  <div id="pinBox">
    <input id="usernameInput" placeholder="Enter username" autocomplete="off" />
    <input id="pinInput" placeholder="Enter PIN" type="password" autocomplete="current-password" />
    <button id="pinBtn">Enter Chat</button>
  </div>
</div>

<div id="chatApp" aria-hidden="true">
  <header>
    <div>Chatify</div>
    <div class="header-actions">
      <button id="profileBtn" class="button-clear" title="Set profile picture">Profile</button>
      <button id="toggleThemeBtn" class="button-clear" title="Toggle theme">Toggle Theme</button>
      <button id="adminBtn" class="admin-panel-btn" style="display:none">Admin</button>
      <button id="signoutBtn" class="button-clear" title="Sign out" style="color:salmon">Sign out</button>
    </div>
  </header>

  <div id="loading"><div class="loader"></div></div>
  <div id="chat" role="log" aria-live="polite"></div>

  <footer>
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">➤</button>
  </footer>
</div>

<!-- Admin modal -->
<div id="adminModal" class="admin-modal" role="dialog" aria-hidden="true">
  <h3>Admin Control Center</h3>
  <div style="font-size:13px;margin-bottom:8px;color:var(--text-color)">Root controls</div>

  <div class="control-row">
    <input id="delId" placeholder="message id to delete" />
    <button id="delByIdBtn">Delete</button>
  </div>

  <div class="control-row">
    <button id="deleteAllBtn">Delete All Messages</button>
  </div>

  <div class="control-row">
    <input id="editId" placeholder="message id to edit timestamp" />
    <input id="editTimestamp" placeholder="new timestamp (e.g. 3:25 PM)" />
    <button id="editTsBtn">Edit TS</button>
  </div>

  <div class="control-row">
    <input id="banUserInput" placeholder="username to ban/unban" />
    <button id="banBtn">Ban</button>
    <button id="unbanBtn">Unban</button>
  </div>

  <div class="control-row">
    <input id="notifyText" placeholder="notification text" />
    <button id="notifyBtn">Notify</button>
  </div>

  <div style="font-size:12px;color:#6b7280;margin-top:8px">Admin user: <strong>root</strong> — Admin PIN: <strong>qwery</strong></div>
</div>

<!-- Profile Picture Modal -->
<div id="profileModal" class="profile-modal">
  <div class="profile-modal-content">
    <h3>Set Profile Picture</h3>
    <img id="profilePreview" class="profile-preview" src="https://via.placeholder.com/80" alt="Profile preview" />
    <div class="profile-input-container">
      <input type="text" id="profileUrlInput" placeholder="Enter image URL" />
    </div>
    <div class="profile-modal-actions">
      <button id="cancelProfileBtn">Cancel</button>
      <button id="saveProfileBtn">Save</button>
    </div>
  </div>
</div>

<div id="notifyBanner" class="notify-banner"></div>

<audio id="newMessageSound" src="https://www.soundjay.com/button/sounds/button-3.mp3" preload="auto"></audio>
<script>
/* ==== Config ==== */
const ADMIN_USERNAME = 'root';
const ADMIN_PIN = 'qwery';
const PIN_CODE = '5432'; // regular pin

/* ==== Supabase Configuration ==== */
const SUPABASE_URL = "https://kqbylnsogapepslmxtwv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtxYnlsbnNvZ2FwZXBzbG14dHd2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDYzNDkwMywiZXhwIjoyMDc2MjEwOTAzfQ.wCMSO-UuZtBbpJzEUKx8nz5MGtnx7aJBWEIozC9a6dM";
const TABLE = "messages"; // public.messages

/* ==== Supabase Instance ==== */
let supabase = null;
let realtimeSubscription = null;
let usersChannel = null;

/* ==== Elements ==== */
const pinOverlay = document.getElementById('pinOverlay');
const usernameInput = document.getElementById('usernameInput');
const pinInput = document.getElementById('pinInput');
const pinBtn = document.getElementById('pinBtn');
const chatApp = document.getElementById('chatApp');
const chatDiv = document.getElementById('chat');
const loadingDiv = document.getElementById('loading');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const adminBtn = document.getElementById('adminBtn');
const adminModal = document.getElementById('adminModal');
const notifyBanner = document.getElementById('notifyBanner');
const newMessageSound = document.getElementById('newMessageSound');
const toggleThemeBtn = document.getElementById('toggleThemeBtn');
const signoutBtn = document.getElementById('signoutBtn');
const profileBtn = document.getElementById('profileBtn');
const profileModal = document.getElementById('profileModal');
const profileUrlInput = document.getElementById('profileUrlInput');
const profilePreview = document.getElementById('profilePreview');
const cancelProfileBtn = document.getElementById('cancelProfileBtn');
const saveProfileBtn = document.getElementById('saveProfileBtn');

/* Admin controls */
const delIdInput = document.getElementById('delId');
const delByIdBtn = document.getElementById('delByIdBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const editIdInput = document.getElementById('editId');
const editTsInput = document.getElementById('editTimestamp');
const editTsBtn = document.getElementById('editTsBtn');
const banUserInput = document.getElementById('banUserInput');
const banBtn = document.getElementById('banBtn');
const unbanBtn = document.getElementById('unbanBtn');
const notifyTextInput = document.getElementById('notifyText');
const notifyBtn = document.getElementById('notifyBtn');

/* ==== State ==== */
let currentUser = null;
let messages = [];        // persisted master copy
let displayed = new Set(); // ids rendered
let bannedUsers = new Set();
let userProfiles = {};    // {username: pfp_url}
let isAdmin = false;
let isTabActive = true;
let workingColumn = null; // for dynamic column detection

/* ==== Tab visibility detection ==== */
document.addEventListener('visibilitychange', () => {
  isTabActive = !document.hidden;
});

/* ==== Theme init ==== */
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
document.documentElement.setAttribute('data-theme', savedTheme || (prefersDark ? 'dark' : 'light'));
toggleThemeBtn.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
});

/* ==== Persistence helpers ==== */
function loadLocalState(){
  try{ const raw = localStorage.getItem('chatMessages'); if(raw) messages = JSON.parse(raw); }catch(e){ messages = []; }
  try{ const bu = localStorage.getItem('chatBanned'); if(bu) bannedUsers = new Set(JSON.parse(bu)); }catch(e){ bannedUsers = new Set(); }
}
function saveLocalState(){ localStorage.setItem('chatMessages', JSON.stringify(messages)); localStorage.setItem('chatBanned', JSON.stringify([...bannedUsers])); }

/* ==== Utilities ==== */
function makeId(){ return Date.now() + "-" + Math.random().toString(36).slice(2,9); }
function formatTS(ts){ return ts || new Date().toLocaleTimeString(); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ==== Supabase Column Detection Logic ==== */
async function tryInsertColumn(colName, row) {
  try {
    const r = await supabase
      .from(TABLE)
      .insert([row])
      .select();
    if (r.error) {
      return { ok: false, error: r.error };
    }
    return { ok:true, data: r.data };
  } catch (e) {
    return { ok:false, error: e };
  }
}

async function determineColumnAndSend(username, text) {
  const candidates = ['content','message','text'];
  if (workingColumn) {
    return await insertWithColumn(workingColumn, username, text);
  }
  for (const col of candidates) {
    console.log(`Trying insert with column "${col}"...`);
    const row = { username, [col]: text, id: makeId(), timestamp: formatTS() };
    const res = await tryInsertColumn(col, row);
    if (res.ok) {
      console.log(`Insert ok with column "${col}". Using it from now on.`);
      workingColumn = col;
      return { ok:true, col, data:res.data };
    } else {
      const errObj = res.error;
      console.log(`Insert failed for "${col}":`, errObj);
      const m = errObj && (errObj.message || errObj.error || JSON.stringify(errObj));
      if (m && m.toString().includes("Could not find the")) {
        continue;
      } else {
        return { ok:false, error: errObj };
      }
    }
  }
  return { ok:false, error: "No writable text column found among candidates: content,message,text" };
}

async function insertWithColumn(col, username, text) {
  try {
    const row = { username, [col]: text, id: makeId(), timestamp: formatTS() };
    const r = await supabase.from(TABLE).insert([row]).select();
    if (r.error) {
      return { ok:false, error:r.error };
    }
    return { ok:true, data: r.data, col };
  } catch (e) {
    return { ok:false, error:e };
  }
}

async function determineColumnAndSend(username, text) {
  const candidates = ['content','message','text'];
  // if we already discovered workingColumn, use it
  if (workingColumn) {
    return await insertWithColumn(workingColumn, username, text);
  }
  // else try each candidate but safely: use limit 1 test insert then delete it
  for (const col of candidates) {
    console.log(`Trying insert with column "${col}"...`);
    const row = { username, [col]: text };
    const res = await tryInsertColumn(col, row);
    if (res.ok) {
      console.log(`Insert ok with column "${col}". Using it from now on.`);
      workingColumn = col;
      return { ok:true, col, data:res.data };
    } else {
      // Check PostgREST error shape for missing column: PGRST204
      const errObj = res.error;
      console.log(`Insert failed for "${col}":`, errObj);
      // If message contains "Could not find the 'X' column" we continue
      const m = errObj && (errObj.message || errObj.error || JSON.stringify(errObj));
      if (m && m.toString().includes("Could not find the")) {
        // try next
        continue;
      } else {
        // unknown error (for example, CORS, network, 403)
        return { ok:false, error: errObj };
      }
    }
  }
  return { ok:false, error: "No writable text column found among candidates: content,message,text" };
}

async function insertWithColumn(col, username, text) {
  try {
    const row = { username, [col]: text };
    const r = await supabase.from(TABLE).insert([row]).select();
    if (r.error) {
      return { ok:false, error:r.error };
    }
    return { ok:true, data: r.data, col };
  } catch (e) {
    return { ok:false, error:e };
  }
}

/* ==== Load profiles from Supabase ==== */
async function loadProfiles() {
  const { data, error } = await supabase.from('users').select('username, pfp_url');
  if (error) {
    if (error.message.includes("Could not find the table")) {
      console.warn('Users table not found, creating...');
      await createUsersTable();
    } else {
      console.error('Load profiles error:', error);
      showNotifyBanner('Failed to load profiles: ' + error.message);
      return;
    }
  }
  if (data) {
    data.forEach(u => {
      userProfiles[u.username] = u.pfp_url;
    });
  }
}

/* ==== Create users table if not exists ==== */
async function createUsersTable() {
  // Note: Supabase doesn't allow direct table creation via client-side JS.
  // You must create the table manually in the Supabase dashboard or SQL editor.
  // This function is a placeholder to log the requirement.
  console.log('Please create the "users" table in Supabase with the following SQL:');
  console.log(`
    create table users (
      username text primary key,
      pfp_url text
    );
    alter table users enable row level security;
    create policy "anon can read users" on users for select using (true);
    create policy "anon can upsert users" on users for insert with check (true);
    create policy "anon can update users" on users for update using (true);
    -- Enable Realtime
    alter publication supabase_realtime add table users;
  `);
  showNotifyBanner('Users table not found. Please create it in Supabase SQL editor.');
}

/* ==== Render ==== */
function clearChatAndRenderAll(){
  chatDiv.innerHTML = '';
  displayed.clear();
  for(const m of messages){ renderOneMessage(m,false); }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
function renderOneMessage(msg, live=false){
  if(displayed.has(msg.id)) return;
  displayed.add(msg.id);
  const isBanned = bannedUsers.has(msg.username);
  const el = document.createElement('div');
  el.className = 'message ' + (msg.username === (currentUser && currentUser.username) ? 'myMessage' : 'otherMessage');
  el.dataset.id = msg.id;
//profile picture placeholder here!!!
  const profilePic = userProfiles[msg.username] || 'https://www.thisiscolossal.com/wp-content/uploads/2024/01/spherewave.gif';
  const content = msg.deleted ? "<em>Message deleted</em>" :
    (msg.message && msg.message.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i) ? `<img src="${escapeHtml(msg.message)}" style="max-width:260px;border-radius:8px" />` :
      (msg.message && msg.message.match(/^https?:\/\//i) ? `<a href="${escapeHtml(msg.message)}" target="_blank" rel="noreferrer">${escapeHtml(msg.message)}</a>` :
       escapeHtml(msg.message || '')));

  const bannedNote = isBanned ? `<div style="font-size:12px;color:#bf3b3b;margin-bottom:6px">[BANNED USER]</div>` : '';
  el.innerHTML = `
    <img src="${escapeHtml(profilePic)}" alt="pfp" style="width:30px;height:30px;border-radius:50%;margin-right:10px;vertical-align:middle;">
    <div>${bannedNote}<strong>${escapeHtml(msg.username)}</strong>: ${content}</div><div class="timestamp">${escapeHtml(msg.timestamp || '')}</div>
  `;

  if((isAdmin) || (currentUser && msg.username === currentUser.username && !msg.deleted)){
    const opt = document.createElement('div'); opt.className = 'options'; opt.textContent = '⋮';
    const menu = document.createElement('div'); menu.className = 'options-menu';
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete';
    delBtn.onclick = () => {
      const idx = messages.findIndex(m=>m.id===msg.id);
      if(idx>=0){ messages[idx].deleted = true; saveLocalState(); }
      deleteMessage(msg.id);
      menu.style.display='none';
      clearChatAndRenderAll();
    };
    menu.appendChild(delBtn);
    if(isAdmin){
      const editBtn = document.createElement('button'); editBtn.textContent = 'Edit timestamp';
      editBtn.onclick = () => {
        const newTs = prompt('Enter new timestamp (e.g. 3:25 PM):', msg.timestamp || '');
        if(newTs != null){
          const idx = messages.findIndex(m=>m.id===msg.id);
          if(idx>=0){ messages[idx].timestamp = newTs; saveLocalState(); }
          updateMessageTimestamp(msg.id, newTs);
          clearChatAndRenderAll();
        }
        menu.style.display='none';
      };
      menu.appendChild(editBtn);
      const forceDelBtn = document.createElement('button'); forceDelBtn.textContent = 'Force delete (admin)';
      forceDelBtn.onclick = () => {
        if(!confirm('Confirm force delete this message for all users?')) return;
        const idx = messages.findIndex(m=>m.id===msg.id);
        if(idx>=0){ messages[idx].deleted = true; saveLocalState(); }
        deleteMessage(msg.id);
        clearChatAndRenderAll();
        menu.style.display='none';
      };
      menu.appendChild(forceDelBtn);
    }
    opt.onclick = ()=> menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    el.appendChild(opt);
    el.appendChild(menu);
  }

  chatDiv.appendChild(el);
  if(live && currentUser && msg.username !== currentUser.username && !msg.deleted){
    if (!isTabActive) {
      if(msg.message && msg.message.includes('@' + currentUser.username)){
        alert(`Mentioned: ${msg.username}: ${msg.message}`);
      } else {
        alert(`New message from ${msg.username}: ${msg.message}`);
      }
      newMessageSound.play();
    }
  }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

/* ==== Supabase Functions ==== */
function initializeSupabase() {
  try {
    if (!window.supabase) {
      console.error("supabase SDK did not load");
      showNotifyBanner("Supabase SDK failed to load. Check network.");
      return;
    }
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    fetchRecent().then(() => {
      subscribeRealtime();
      loadProfiles();
    }).catch(e => console.error(e));
  } catch (error) {
    console.error('Error initializing Supabase:', error);
    showNotifyBanner('Error connecting to database');
  }
}

async function fetchRecent(){
  loadingDiv.style.display = 'flex';
  try {
    let selectCols = 'id, username, content, message, text, created_at, timestamp';
    let r = await supabase.from(TABLE).select(selectCols).order('created_at',{descending:true}).limit(300000000);
    if (r.error) {
      console.log('Select with candidate columns failed, trying select * — error:', r.error);
      r = await supabase.from(TABLE).select('*').order('created_at',{descending:true}).limit(3000000);
    }
    if (r.error) {
      console.error('Fetch failed:', r.error);
      showNotifyBanner('Fetch failed: ' + (r.error.message || JSON.stringify(r.error)));
      return;
    }
    
    
    
    messages = r.data.map(m => {
      const text = m.content || m.message || m.text || '';
      return {
        id: m.id || makeId(),
        username: m.username || 'anon',
        message: text,
        timestamp: m.timestamp || (m.created_at ? new Date(m.created_at).toLocaleTimeString() : ''),
        deleted: m.deleted || false
      };
    });
    
    saveLocalState();
    clearChatAndRenderAll();
  } catch (e) {
    console.error('Fetch exception:', e);
    showNotifyBanner('Fetch exception: ' + e.message);
  } finally {
    loadingDiv.style.display = 'none';
  }
}

async function subscribeRealtime() {
  try {
    if (realtimeSubscription) {
      console.log('Realtime already subscribed.');
      return;
    }
    realtimeSubscription = supabase.channel('public:'+TABLE)
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: TABLE }, (payload) => {
        console.log('Realtime INSERT:', payload.new);
        const m = payload.new;
        const text = m.content || m.message || m.text || '';
        const newMessage = {
          id: m.id || makeId(),
          username: m.username || 'anon',
          message: text,
          timestamp: m.timestamp || (m.created_at ? new Date(m.created_at).toLocaleTimeString() : ''),
          deleted: m.deleted || false
        };
        
        const idx = messages.findIndex(msg => msg.id === newMessage.id);
        if (idx === -1) {
          messages.push(newMessage);
          saveLocalState();
          renderOneMessage(newMessage, true);
        }
      })
      .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: TABLE }, (payload) => {
        const m = payload.new;
        const text = m.content || m.message || m.text || '';
        const updatedMessage = {
          id: m.id,
          username: m.username || 'anon',
          message: text,
          timestamp: m.timestamp || (m.created_at ? new Date(m.created_at).toLocaleTimeString() : ''),
          deleted: m.deleted || false
        };
        const idx = messages.findIndex(msg => msg.id === updatedMessage.id);
        if (idx !== -1) {
          messages[idx] = updatedMessage;
          saveLocalState();
          clearChatAndRenderAll();
        }
      })
      .on('postgres_changes', { event: 'DELETE', schema: 'public', table: TABLE }, (payload) => {
        const deletedId = payload.old.id;
        messages = messages.filter(m => m.id !== deletedId);
        saveLocalState();
        clearChatAndRenderAll();
      })
      .subscribe();
    console.log('Realtime subscription created');
  } catch (e) {
    console.error('Realtime subscribe error:', e);
    showNotifyBanner('Realtime subscribe error: ' + (e.message||e));
  }
}

async function deleteMessage(id) {
  try {
    const { error } = await supabase
      .from(TABLE)
      .delete()
      .eq('id', id);
    
    if (error) {
      console.error('Delete error:', error);
      showNotifyBanner('Delete failed: ' + error.message);
    }
  } catch (e) {
    console.error('Delete exception:', e);
    showNotifyBanner('Delete exception: ' + e.message);
  }
}

async function updateMessageTimestamp(id, newTimestamp) {
  try {
    const { error } = await supabase
      .from(TABLE)
      .update({ timestamp: newTimestamp })
      .eq('id', id);
    if (error) {
      console.error('Update timestamp error:', error);
      showNotifyBanner('Update timestamp error: ' + error.message);
    }
  } catch (e) {
    console.error('Update timestamp exception:', e);
    showNotifyBanner('Update timestamp exception: ' + e.message);
  }
}

/* ==== Load local state and initial render ==== */
loadLocalState();
if(localStorage.getItem('chatUser')){
  currentUser = JSON.parse(localStorage.getItem('chatUser'));
  if(currentUser.username === ADMIN_USERNAME && localStorage.getItem('lastPin') === ADMIN_PIN){
    isAdmin = true;
    adminBtn.style.display = 'inline-block';
  }
  pinOverlay.style.display = 'none';
  chatApp.style.display = 'flex';
  initializeSupabase();
  if(messages.length) messages.forEach(m => renderOneMessage(m,false));
}

/* ==== Send message ==== */
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
async function sendMessage(){
  const text = (messageInput.value || '').trim();
  if(!text || !currentUser) return;
  if(bannedUsers.has(currentUser.username)){
    showNotifyBanner('You are banned from sending messages.');
    return;
  }
  
  const result = await determineColumnAndSend(currentUser.username, text);
  if (!result.ok) {
    showNotifyBanner('Send failed: ' + (result.error && result.error.message ? result.error.message : JSON.stringify(result.error)));
    console.error('Detailed send error:', result.error);
    return;
  }
  
  messageInput.value = '';
}

/* ==== PIN login logic ==== */
pinBtn.addEventListener('click', async () => {
  const username = (usernameInput.value || '').trim();
  const pin = (pinInput.value || '').trim();
  if(!username) return;
  currentUser = { username };
  localStorage.setItem('chatUser', JSON.stringify(currentUser));
  if(username === ADMIN_USERNAME && pin === ADMIN_PIN){
    isAdmin = true;
    adminBtn.style.display = 'inline-block';
    localStorage.setItem('lastPin', ADMIN_PIN);
  } else {
    isAdmin = false;
    adminBtn.style.display = 'none';
    localStorage.removeItem('lastPin');
  }
  const allowedPin = (username === ADMIN_USERNAME && pin === ADMIN_PIN) ? ADMIN_PIN : PIN_CODE;
  if(pin !== allowedPin) {
    alert('Wrong PIN');
    localStorage.removeItem('chatUser');
    currentUser = null;
    return;
  }
  pinOverlay.style.display = 'none';
  chatApp.style.display = 'flex';
  initializeSupabase();
  loadLocalState();
  if(messages.length) clearChatAndRenderAll();
});

/* ==== Admin modal toggle ==== */
adminBtn.addEventListener('click', () => {
  adminModal.style.display = adminModal.style.display === 'block' ? 'none' : 'block';
  adminModal.setAttribute('aria-hidden', adminModal.style.display === 'none');
});

/* ==== Admin actions ==== */
delByIdBtn.addEventListener('click', () => {
  if(!isAdmin) return;
  const id = (delIdInput.value||'').trim();
  if(!id) return showNotifyBanner('Provide id to delete.');
  const idx = messages.findIndex(m=>m.id===id);
  if(idx === -1) return showNotifyBanner('Message id not found.');
  messages[idx].deleted = true;
  saveLocalState();
  deleteMessage(id);
  clearChatAndRenderAll();
  showNotifyBanner('Message deleted.');
});
deleteAllBtn.addEventListener('click', () => {
  if(!isAdmin) return;
  if(!confirm('Confirm delete all messages for everyone?')) return;
  for(const msg of messages){ 
    msg.deleted = true; 
    deleteMessage(msg.id);
  }
  saveLocalState();
  clearChatAndRenderAll();
  showNotifyBanner('All messages deleted.');
});
editTsBtn.addEventListener('click', () => {
  if(!isAdmin) return;
  const id = (editIdInput.value||'').trim();
  const newTs = (editTsInput.value||'').trim();
  if(!id || !newTs) return showNotifyBanner('Provide id and new timestamp.');
  const idx = messages.findIndex(m=>m.id===id);
  if(idx === -1) return showNotifyBanner('Message id not found.');
  messages[idx].timestamp = newTs;
  saveLocalState();
  updateMessageTimestamp(id, newTs);
  clearChatAndRenderAll();
  showNotifyBanner('Timestamp updated.');
});
banBtn.addEventListener('click', () => {
  if(!isAdmin) return;
  const t = (banUserInput.value||'').trim();
  if(!t) return showNotifyBanner('Provide username to ban.');
  bannedUsers.add(t);
  saveLocalState();
  showNotifyBanner(`User ${t} banned.`);
});
unbanBtn.addEventListener('click', () => {
  if(!isAdmin) return;
  const t = (banUserInput.value||'').trim();
  if(!t) return showNotifyBanner('Provide username to unban.');
  bannedUsers.delete(t);
  saveLocalState();
  showNotifyBanner(`User ${t} unbanned.`);
});
notifyBtn.addEventListener('click', () => {
  if(!isAdmin) return;
  const txt = (notifyTextInput.value||'').trim();
  if(!txt) return showNotifyBanner('Provide notification text.');
  showNotifyBanner(txt);
});

/* ==== Profile modal logic ==== */
profileBtn.addEventListener('click', () => {
  profileModal.style.display = 'flex';
  profileUrlInput.value = userProfiles[currentUser.username] || '';
  profilePreview.src = userProfiles[currentUser.username] || 'https://via.placeholder.com/80';
});
cancelProfileBtn.addEventListener('click', () => {
  profileModal.style.display = 'none';
});
profileUrlInput.addEventListener('input', (e) => {
  const url = e.target.value.trim();
  if (url) {
    profilePreview.src = url;
  }
});
saveProfileBtn.addEventListener('click', async () => {
  const url = profileUrlInput.value.trim();
  if (!url) {
    showNotifyBanner('Enter a valid URL');
    return;
  }
  const { error } = await supabase.from('users').upsert({ username: currentUser.username, pfp_url: url });
  if (error) {
    showNotifyBanner('Save failed: ' + error.message);
    return;
  }
  userProfiles[currentUser.username] = url;
  profileModal.style.display = 'none';
  showNotifyBanner('PFP updated');
  clearChatAndRenderAll();
});
usersChannel = supabase.channel('public:users');
usersChannel.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users' }, payload => {
  const u = payload.new;
  userProfiles[u.username] = u.pfp_url;
  clearChatAndRenderAll();
}).subscribe();

/* ==== Notifications (animated banner) ==== */
let bannerTimer = null;
function showNotifyBanner(text){
  notifyBanner.textContent = text;
  notifyBanner.style.display = 'block';
  if(bannerTimer) clearTimeout(bannerTimer);
  bannerTimer = setTimeout(()=> notifyBanner.style.display = 'none', 9000);
}

/* ==== Other UI controls ==== */
signoutBtn.addEventListener('click', () => { 
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }
  if (usersChannel) {
    supabase.removeChannel(usersChannel);
  }
  localStorage.removeItem('chatUser'); 
  localStorage.removeItem('lastPin'); 
  location.reload(); 
});

/* ==== Before unload: cleanup ==== */
window.addEventListener('beforeunload', () => {
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }
  if (usersChannel) {
    supabase.removeChannel(usersChannel);
  }
});

/* ==== Startup Initialization Function ==== */
(async function initializeApp() {
    console.log('Starting application initialization...');
    
    // 1. Load profiles first (this is an async operation)
    await loadProfiles(); 
    
    // 2. You might have other initial data loading here, e.g.,
    // await loadInitialMessages();
    
    // 3. Render the entire UI now that the data is ready
    // This will run the function immediately when the program starts
    console.log('All initial data loaded. Rendering UI...');
    clearChatAndRenderAll(); // ⬅️ FIRST RUN CALL
    
    // 4. Set up the Supabase Realtime listeners
    // This is where the SECOND run will be called if an update occurs later
    usersChannel = supabase.channel('public:users');
    usersChannel.on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users' }, payload => {
        const u = payload.new;
        userProfiles[u.username] = u.pfp_url;
        clearChatAndRenderAll(); 
    }).subscribe();

    console.log('Application fully initialized.');
})();

// NOTE: Ensure your loadProfiles function is defined and accessible.
</script>
</body>
</html>
