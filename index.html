<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <script src="https://cdn.jsdelivr.net/npm/ably@1.2.39/browser/static/ably.min.js"></script>
  <style>
    body {
      margin:0;
      font-family: Arial, sans-serif;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:#f0f0f0;
    }
    #loginScreen {
      margin:auto;
      text-align:center;
    }
    #chatContainer {
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    #chat {
      flex:1;
      overflow-y:auto;
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:url('https://cdn.vectorstock.com/i/1000v/86/67/hi-icon-greet-and-hello-symbol-flat-vector-6608667.jpg') no-repeat center center;
      background-size:cover;
    }
    .message {
      max-width:60%;
      padding:10px 14px;
      border-radius:18px;
      position:relative;
      display:inline-block;
      word-wrap:break-word;
    }
    .own {
      align-self:flex-end;
      background:#0b93f6;
      color:white;
    }
    .other {
      align-self:flex-start;
      background:#e5e5ea;
      color:black;
    }
    .username {
      font-size:0.8em;
      font-weight:bold;
      margin-bottom:4px;
    }
    .menu {
      position:absolute;
      top:4px;
      right:8px;
      cursor:pointer;
      font-weight:bold;
    }
    .inputArea {
      display:flex;
      padding:10px;
      background:white;
    }
    .inputArea input {
      flex:1;
      padding:10px;
      border:1px solid #ccc;
      border-radius:20px;
      outline:none;
    }
    .inputArea button {
      margin-left:8px;
      padding:10px 16px;
      border:none;
      border-radius:20px;
      background:#0b93f6;
      color:white;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="loginScreen">
    <h2>Enter PIN</h2>
    <input id="pinInput" type="password" placeholder="PIN"><br><br>
    <input id="nameInput" type="text" placeholder="Your display name"><br><br>
    <button id="loginBtn">Enter</button>
  </div>

  <div id="chatContainer" style="display:none;">
    <div id="chat"></div>
    <div class="inputArea">
      <input id="messageInput" type="text" placeholder="Type a message or image URL...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script>
    const PIN = "5432";
    const API_KEY = "Vtd4-A.9jmIFA:umDML_i9STQP4BIH_u2Jon5BlkxuiK36w37FVrkhEl4";
    const chatDiv = document.getElementById('chat');
    const loginScreen = document.getElementById('loginScreen');
    const chatContainer = document.getElementById('chatContainer');
    let username = localStorage.getItem('chat-username');
    let pinSaved = localStorage.getItem('chat-pin-ok');
    let ably, channel;

    // If already logged in
    if(username && pinSaved){
      startChat(username);
    }

    document.getElementById('loginBtn').onclick = ()=>{
      const pin = document.getElementById('pinInput').value;
      const name = document.getElementById('nameInput').value.trim() || "Anonymous";
      if(pin===PIN){
        localStorage.setItem('chat-pin-ok','yes');
        localStorage.setItem('chat-username', name);
        startChat(name);
      } else {
        alert("Wrong PIN!");
      }
    }

    function startChat(name){
      username = name;
      loginScreen.style.display='none';
      chatContainer.style.display='flex';
      ably = new Ably.Realtime(API_KEY);
      channel = ably.channels.get("global-chat");

      // Load all history recursively
      loadAllHistory(channel, (msg)=>{
        const data = JSON.parse(msg.data);
        renderMessage(msg.id, data.username, data.message, data.timestamp);
      });

      // Subscribe to new messages
      channel.subscribe('message', msg=>{
        const data = JSON.parse(msg.data);
        renderMessage(msg.id, data.username, data.message, data.timestamp);
      });

      document.getElementById('sendBtn').onclick = sendMessage;
      document.getElementById('messageInput').addEventListener('keydown', e=>{
        if(e.key==='Enter') sendMessage();
      });
    }

    function loadAllHistory(channel, callback){
      let params = {direction:'forwards', limit:100};
      function page(historyPage){
        historyPage.items.forEach(callback);
        if(historyPage.hasNext()){
          historyPage.next().then(page);
        }
      }
      channel.history(params).then(page);
    }

    function sendMessage(){
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if(!text) return;
      const data = {username:username, message:text, timestamp:Date.now()};
      channel.publish('message', JSON.stringify(data));
      input.value='';
    }

    function renderMessage(id, user, message, timestamp){
      if(document.getElementById(id)) return; // don’t duplicate
      const div = document.createElement('div');
      div.className='message '+(user===username?'own':'other');
      div.id=id;
      div.innerHTML = `
        <div class="username">${user}</div>
        ${message.match(/\.(jpeg|jpg|gif|png|webp)$/i) 
          ? `<img src="${message}" style="max-width:200px;border-radius:10px;">`
          : `<div>${message}</div>`}
        ${(user===username)?'<div class="menu">⋮</div>':''}
      `;
      chatDiv.appendChild(div);
      chatDiv.scrollTop=chatDiv.scrollHeight;

      // Menu delete
      if(user===username){
        div.querySelector('.menu').onclick=()=>{
          if(confirm("Delete this message?")){
            channel.publish('delete',{id});
            div.remove();
          }
        }
      }
    }

    // Listen for deletes
    setTimeout(()=>{
      if(channel){
        channel.subscribe('delete', msg=>{
          const {id} = msg.data;
          const m = document.getElementById(id);
          if(m) m.remove();
        });
      }
    },2000);
  </script>
</body>
</html>
