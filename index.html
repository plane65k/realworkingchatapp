<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ably Chat</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: white;
      color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background-color: black;
        color: white;
      }
      #chat {
        background: #1e1e1e;
        color: white;
      }
    }
    #app {
      width: 90%;
      max-width: 1000px;
      display: flex;
      flex-direction: row;
      gap: 15px;
    }
    #chat {
      flex: 2;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow-y: auto;
      padding: 10px;
      height: 80vh;
      background: #fff;
    }
    #sidebar {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 5px;
      background-color: #f0f0f0;
    }
    .message strong {
      color: #2c7be5;
    }
    .timestamp {
      font-size: 0.8em;
      color: gray;
    }
    #input-area {
      display: flex;
      gap: 5px;
    }
    #message {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #send {
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #2c7be5;
      color: white;
      cursor: pointer;
    }
    #send:hover {
      background: #1a5dbb;
    }
    #auth {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #auth input, #auth button {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    img.chat-img {
      max-width: 200px;
      border-radius: 5px;
      display: block;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div id="auth" style="display:none;">
    <h2>Login / Register</h2>
    <input type="text" id="auth-username" placeholder="Username">
    <input type="password" id="auth-password" placeholder="Password / PIN">
    <button id="register">Register</button>
    <button id="login">Login</button>
    <p id="auth-status"></p>
  </div>

  <div id="app" style="display:none;">
    <div id="chat"></div>
    <div id="sidebar">
      <div id="input-area">
        <input type="text" id="message" placeholder="Type a message or paste image URL...">
        <button id="send">Send</button>
      </div>
      <p id="user-info"></p>
    </div>
  </div>

  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <script>
    const ably = new Ably.Realtime('YOUR_ABLY_API_KEY'); // Replace with your Ably key
    const chatChannel = ably.channels.get('chat-room');
    const accountsChannel = ably.channels.get('accounts');

    const authDiv = document.getElementById('auth');
    const appDiv = document.getElementById('app');
    const chatDiv = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendButton = document.getElementById('send');
    const userInfo = document.getElementById('user-info');

    let currentUser = null;

    // Load stored user
    const storedUser = JSON.parse(localStorage.getItem('ablyUser'));
    if (storedUser) {
      currentUser = storedUser;
      showApp();
    } else {
      authDiv.style.display = "flex";
    }

    // Register
    document.getElementById('register').addEventListener('click', async () => {
      const username = document.getElementById('auth-username').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      if (!username || !password) return;

      let exists = false;
      await accountsChannel.history({ limit: 100 }).then(page => {
        page.items.forEach(msg => {
          const acc = JSON.parse(msg.data);
          if (acc.username === username) exists = true;
        });
      });

      if (exists) {
        document.getElementById('auth-status').innerText = "Username already exists!";
        return;
      }

      const account = { username, password };
      accountsChannel.publish('register', JSON.stringify(account));
      localStorage.setItem('ablyUser', JSON.stringify(account));
      currentUser = account;
      showApp();
    });

    // Login
    document.getElementById('login').addEventListener('click', async () => {
      const username = document.getElementById('auth-username').value.trim();
      const password = document.getElementById('auth-password').value.trim();
      if (!username || !password) return;

      let success = false;
      await accountsChannel.history({ limit: 100 }).then(page => {
        page.items.forEach(msg => {
          const acc = JSON.parse(msg.data);
          if (acc.username === username && acc.password === password) {
            success = true;
            currentUser = acc;
            localStorage.setItem('ablyUser', JSON.stringify(acc));
          }
        });
      });

      if (!success) {
        document.getElementById('auth-status').innerText = "Invalid login!";
        return;
      }
      showApp();
    });

    function showApp() {
      authDiv.style.display = "none";
      appDiv.style.display = "flex";
      userInfo.innerText = "Logged in as: " + currentUser.username;
      loadMessages();
      subscribeMessages();
    }

    // Load past chat messages
    function loadMessages() {
      chatChannel.history({ limit: 100 }).then(page => {
        chatDiv.innerHTML = "";
        page.items.reverse().forEach(msg => {
          const { username, message, timestamp } = JSON.parse(msg.data);
          displayMessage({ username, message, timestamp });
        });
      });
    }

    // Subscribe to new messages
    function subscribeMessages() {
      chatChannel.subscribe('message', msg => {
        const { username, message, timestamp } = JSON.parse(msg.data);
        displayMessage({ username, message, timestamp });
      });
    }

    // Send message
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const timestamp = Date.now();
      const data = JSON.stringify({ username: currentUser.username, message: text, timestamp });
      chatChannel.publish('message', data);
      messageInput.value = '';
    }

    // Display message
    function displayMessage({ username, message, timestamp }) {
      const div = document.createElement('div');
      div.className = 'message';
      let content = `<strong>${username}</strong>: ${escapeHTML(message)} <span class="timestamp">(${new Date(timestamp).toLocaleTimeString()})</span>`;

      // If message looks like an image URL
      if (message.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
        content += `<br><img src="${message}" class="chat-img">`;
      }
      div.innerHTML = content;
      chatDiv.appendChild(div);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function escapeHTML(str) {
      return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>
