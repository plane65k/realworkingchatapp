<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatify (Admin-enabled)</title>
<style>
:root {
  --background-color: #f5f5f5;
  --text-color: #333333;
  --card-background: #ffffff;
  --button-background: #4caf50;
  --button-text: #ffffff;
  --secondary-background: #fafafa;
  --border-color: #ccc;
  --shadow-color: rgba(0,0,0,0.2);
  --message-my-background: #4caf50;
  --message-my-text: #ffffff;
  --message-other-background: #e0e0e0;
  --message-other-text: #000000;
  --overlay-background: rgba(0,0,0,0.4);
  --transition-time: 2s;
}
[data-theme="dark"] {
  --background-color: #1a1a1a;
  --text-color: #ffffff;
  --card-background: #2c2c2c;
  --button-background: #45a049;
  --button-text: #ffffff;
  --secondary-background: #333333;
  --border-color: #555555;
  --shadow-color: rgba(255,255,255,0.1);
  --message-my-background: #45a049;
  --message-my-text: #ffffff;
  --message-other-background: #4a4a4a;
  --message-other-text: #ffffff;
  --overlay-background: rgba(255,255,255,0.2);
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
  background:var(--background-color);
  color:var(--text-color);
  transition:background-color var(--transition-time) ease,color var(--transition-time) ease;
  display: flex;
  flex-direction: column;
}

/* PIN overlay */
#pinOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--overlay-background);
  z-index:100;
}
#pinBox{
  background:var(--card-background);
  padding:30px;
  border-radius:16px;
  width:320px;
  box-shadow:0 8px 30px var(--shadow-color)
}
#pinBox input{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--border-color);
  width:100%;
  margin-bottom:10px;
  background:transparent;
  color:var(--text-color)
}
#pinBox button{
  background:var(--button-background);
  color:var(--button-text);
  padding:12px;
  border-radius:12px;
  border:0;
  width:100%;
  cursor:pointer;
  font-weight:700
}

/* Chat App */
#chatApp{
  display:none;
  width:100%;
  height:100vh;
  background:var(--card-background);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  transition:background-color var(--transition-time)
}
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  background:var(--button-background);
  color:var(--button-text);
  font-weight:700;
  flex-shrink: 0;
}
.header-actions{
  display:flex;
  gap:10px;
  align-items:center
}
.button-clear{
  background:none;
  border:none;
  color:var(--button-text);
  cursor:pointer;
  font-weight:600
}
#loading{
  display:none;
  padding:18px;
  align-items:center;
  justify-content:center;
  flex-shrink: 0;
}
.loader{
  border:6px solid var(--secondary-background);
  border-top:6px solid var(--button-background);
  border-radius:50%;
  width:36px;
  height:36px;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

#chat{
  flex:1;
  overflow:auto;
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  background:var(--secondary-background)
}
.message{
  max-width:72%;
  padding:12px 14px;
  border-radius:14px;
  font-size:14px;
  position:relative;
  word-break:break-word;
  transition:transform .18s,opacity .18s
}
.myMessage{
  align-self:flex-end;
  background:var(--message-my-background);
  color:var(--message-my-text);
  border-bottom-right-radius:6px
}
.otherMessage{
  align-self:flex-start;
  background:var(--message-other-background);
  color:var(--message-other-text);
  border-bottom-left-radius:6px
}
.timestamp{
  display:block;
  font-size:11px;
  color:var(--border-color);
  margin-top:6px
}
.options{
  position:absolute;
  top:6px;
  right:8px;
  cursor:pointer
}
.options-menu{
  position:absolute;
  top:26px;
  right:8px;
  background:var(--card-background);
  border:1px solid var(--border-color);
  border-radius:8px;
  padding:6px;
  display:none;
  box-shadow:0 8px 20px var(--shadow-color)
}
.options-menu button{
  display:block;
  background:none;
  border:none;
  padding:6px 10px;
  width:100%;
  text-align:left;
  cursor:pointer;
  color:var(--text-color);
  border-radius:6px
}
.options-menu button:hover{
  background:var(--secondary-background)
}

footer{
  display:flex;
  padding:12px;
  border-top:1px solid var(--border-color);
  background:var(--card-background);
  flex-shrink: 0;
}
footer input{
  flex:1;
  padding:12px;
  border-radius:24px;
  border:1px solid var(--border-color);
  margin-right:10px;
  background:transparent;
  color:var(--text-color)
}
footer button{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:var(--button-background);
  color:var(--button-text);
  font-size:18px;
  cursor:pointer
}

/* Admin modal */
.admin-panel-btn{
  background:rgba(255,255,255,0.12);
  border:none;
  color:var(--button-text);
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer
}
.admin-modal{
  position:fixed;
  right:18px;
  top:18px;
  width:320px;
  background:var(--card-background);
  border:1px solid var(--border-color);
  box-shadow:0 12px 30px var(--shadow-color);
  border-radius:12px;
  padding:12px;
  z-index:120;
  display:none
}
.admin-modal h3{
  margin:0 0 8px 0
}
.control-row{
  display:flex;
  gap:8px;
  margin-bottom:8px
}
.control-row input, .control-row select{
  flex:1;
  padding:8px;
  border-radius:8px;
  border:1px solid var(--border-color);
  background:transparent;
  color:var(--text-color)
}
.control-row button{
  padding:8px 10px;
  border-radius:8px;
  border:0;
  background:var(--button-background);
  color:var(--button-text);
  cursor:pointer
}

/* notification banner */
.notify-banner{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  top:18px;
  background:linear-gradient(90deg,var(--button-background),#2e7d32);
  color:var(--button-text);
  padding:12px 18px;
  border-radius:999px;
  box-shadow:0 12px 30px var(--shadow-color);
  z-index:200;
  display:none;
  animation:bannerIn .35s ease
}
@keyframes bannerIn{
  from{opacity:0;transform:translate(-50%,-6px)}
  to{opacity:1;transform:translate(-50%,0)}
}

a{color:#0a66c2;text-decoration:underline}
</style>
</head>
<body>

<!-- PIN overlay -->
<div id="pinOverlay" aria-hidden="false">
  <div id="pinBox">
    <input id="usernameInput" placeholder="Enter username" autocomplete="off" />
    <input id="pinInput" placeholder="Enter PIN" type="password" autocomplete="current-password" />
    <button id="pinBtn">Enter Chat</button>
  </div>
</div>

<div id="chatApp" aria-hidden="true">
  <header>
    <div>Chatify</div>
    <div class="header-actions">
      <button id="toggleThemeBtn" class="button-clear" title="Toggle theme">Toggle Theme</button>
      <button id="adminBtn" class="admin-panel-btn" style="display:none">Admin</button>
      <button id="signoutBtn" class="button-clear" title="Sign out" style="color:salmon">Sign out</button>
    </div>
  </header>

  <div id="loading"><div class="loader"></div></div>
  <div id="chat" role="log" aria-live="polite"></div>

  <footer>
    <input id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn">➤</button>
  </footer>
</div>

<!-- Admin modal -->
<div id="adminModal" class="admin-modal" role="dialog" aria-hidden="true">
  <h3>Admin Control Center</h3>
  <div style="font-size:13px;margin-bottom:8px;color:var(--text-color)">Root controls</div>

  <div class="control-row">
    <input id="delId" placeholder="message id to delete" />
    <button id="delByIdBtn">Delete</button>
  </div>

  <div class="control-row">
    <button id="deleteAllBtn">Delete All Messages</button>
  </div>

  <div class="control-row">
    <input id="editId" placeholder="message id to edit timestamp" />
    <input id="editTimestamp" placeholder="new timestamp (e.g. 3:25 PM)" />
    <button id="editTsBtn">Edit TS</button>
  </div>

  <div class="control-row">
    <input id="banUserInput" placeholder="username to ban/unban" />
    <button id="banBtn">Ban</button>
    <button id="unbanBtn">Unban</button>
  </div>

  <div class="control-row">
    <input id="notifyText" placeholder="notification text" />
    <button id="notifyBtn">Notify</button>
  </div>

  <div style="font-size:12px;color:#6b7280;margin-top:8px">Admin user: <strong>root</strong> — Admin PIN: <strong>qwery</strong></div>
</div>

<div id="notifyBanner" class="notify-banner"></div>

<audio id="newMessageSound" src="https://www.soundjay.com/button/sounds/button-3.mp3" preload="auto"></audio>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.4.2.min.js"></script>
<script>
/* ==== Config ==== */
const ADMIN_USERNAME = 'root';
const ADMIN_PIN = 'qwery';
const PIN_CODE = '5432'; // regular pin

/* ==== PubNub Configuration ==== */
const PUBLISH_KEY = 'pub-c-f10d7cca-b3fa-4e14-8a0a-e42b9c8c9dc1';
const SUBSCRIBE_KEY = 'sub-c-ed7eb95d-9cfd-49af-b73b-af513120db38';
const SECRET_KEY = 'sec-c-ODcyZTA5MzYtODVjYS00NTVmLTgzYmYtYmUwNDgzMzQ4ZWE3';
const CHANNEL_NAME = 'chat-channel';

/* ==== PubNub Instance ==== */
let pubnub = null;

/* ==== Elements ==== */
const pinOverlay = document.getElementById('pinOverlay');
const usernameInput = document.getElementById('usernameInput');
const pinInput = document.getElementById('pinInput');
const pinBtn = document.getElementById('pinBtn');
const chatApp = document.getElementById('chatApp');
const chatDiv = document.getElementById('chat');
const loadingDiv = document.getElementById('loading');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const adminBtn = document.getElementById('adminBtn');
const adminModal = document.getElementById('adminModal');
const notifyBanner = document.getElementById('notifyBanner');
const newMessageSound = document.getElementById('newMessageSound');
const toggleThemeBtn = document.getElementById('toggleThemeBtn');
const signoutBtn = document.getElementById('signoutBtn');

/* Admin controls */
const delIdInput = document.getElementById('delId');
const delByIdBtn = document.getElementById('delByIdBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const editIdInput = document.getElementById('editId');
const editTsInput = document.getElementById('editTimestamp');
const editTsBtn = document.getElementById('editTsBtn');
const banUserInput = document.getElementById('banUserInput');
const banBtn = document.getElementById('banBtn');
const unbanBtn = document.getElementById('unbanBtn');
const notifyTextInput = document.getElementById('notifyText');
const notifyBtn = document.getElementById('notifyBtn');

/* ==== State ==== */
let currentUser = null;
let messages = [];        // persisted master copy
let displayed = new Set(); // ids rendered
let bannedUsers = new Set();
let isAdmin = false;
let isTabActive = true;

/* ==== Tab visibility detection ==== */
document.addEventListener('visibilitychange', () => {
  isTabActive = !document.hidden;
});

/* ==== Theme init ==== */
const savedTheme = localStorage.getItem('theme');
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
document.documentElement.setAttribute('data-theme', savedTheme || (prefersDark ? 'dark' : 'light'));
toggleThemeBtn.addEventListener('click', () => {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
});

/* ==== Persistence helpers ==== */
function loadLocalState(){
  try{ const raw = localStorage.getItem('chatMessages'); if(raw) messages = JSON.parse(raw); }catch(e){ messages = []; }
  try{ const bu = localStorage.getItem('chatBanned'); if(bu) bannedUsers = new Set(JSON.parse(bu)); }catch(e){ bannedUsers = new Set(); }
}
function saveLocalState(){ localStorage.setItem('chatMessages', JSON.stringify(messages)); localStorage.setItem('chatBanned', JSON.stringify([...bannedUsers])); }

/* ==== Utilities ==== */
function makeId(){ return Date.now() + "-" + Math.random().toString(36).slice(2,9); }
function formatTS(ts){ return ts || new Date().toLocaleTimeString(); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

/* ==== Render ==== */
function clearChatAndRenderAll(){
  chatDiv.innerHTML = '';
  displayed.clear();
  for(const m of messages){ renderOneMessage(m,false); }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
function renderOneMessage(msg, live=false){
  if(displayed.has(msg.id)) return;
  displayed.add(msg.id);
  const isBanned = bannedUsers.has(msg.username);
  const el = document.createElement('div');
  el.className = 'message ' + (msg.username === (currentUser && currentUser.username) ? 'myMessage' : 'otherMessage');
  el.dataset.id = msg.id;

  const content = msg.deleted ? "<em>Message deleted</em>" :
    (msg.message && msg.message.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i) ? `<img src="${escapeHtml(msg.message)}" style="max-width:260px;border-radius:8px" />` :
      (msg.message && msg.message.match(/^https?:\/\//i) ? `<a href="${escapeHtml(msg.message)}" target="_blank" rel="noreferrer">${escapeHtml(msg.message)}</a>` :
       escapeHtml(msg.message || '')));

  const bannedNote = isBanned ? `<div style="font-size:12px;color:#bf3b3b;margin-bottom:6px">[BANNED USER]</div>` : '';
  el.innerHTML = `<div>${bannedNote}<strong>${escapeHtml(msg.username)}</strong>: ${content}</div><div class="timestamp">${escapeHtml(msg.timestamp || '')}</div>`;

  // If admin or message owner, show options menu; admin can delete any message, owner can delete own
  if((isAdmin) || (currentUser && msg.username === currentUser.username && !msg.deleted)){
    const opt = document.createElement('div'); opt.className = 'options'; opt.textContent = '⋮';
    const menu = document.createElement('div'); menu.className = 'options-menu';
    // Delete action (admin or owner)
    const delBtn = document.createElement('button'); delBtn.textContent = 'Delete';
    delBtn.onclick = () => {
      const idx = messages.findIndex(m=>m.id===msg.id);
      if(idx>=0){ messages[idx].deleted = true; saveLocalState(); }
      publishMessage({ ...msg, deleted:true });
      menu.style.display='none';
      clearChatAndRenderAll();
    };
    menu.appendChild(delBtn);
    // If admin, edit timestamp and force-delete option
    if(isAdmin){
      const editBtn = document.createElement('button'); editBtn.textContent = 'Edit timestamp';
      editBtn.onclick = () => {
        const newTs = prompt('Enter new timestamp (e.g. 3:25 PM):', msg.timestamp || '');
        if(newTs != null){
          const idx = messages.findIndex(m=>m.id===msg.id);
          if(idx>=0){ messages[idx].timestamp = newTs; saveLocalState(); }
          publishMessage({ ...msg, timestamp:newTs });
          clearChatAndRenderAll();
        }
        menu.style.display='none';
      };
      menu.appendChild(editBtn);
      const forceDelBtn = document.createElement('button'); forceDelBtn.textContent = 'Force delete (admin)';
      forceDelBtn.onclick = () => {
        if(!confirm('Confirm force delete this message for all users?')) return;
        const idx = messages.findIndex(m=>m.id===msg.id);
        if(idx>=0){ messages[idx].deleted = true; saveLocalState(); }
        publishMessage({ ...msg, deleted:true });
        clearChatAndRenderAll();
        menu.style.display='none';
      };
      menu.appendChild(forceDelBtn);
    }
    opt.onclick = ()=> menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    el.appendChild(opt);
    el.appendChild(menu);
  }

  chatDiv.appendChild(el);
  if(live && currentUser && msg.username !== currentUser.username && !msg.deleted){
    // Only show notifications if tab is not active
    if (!isTabActive) {
      if(msg.message && msg.message.includes('@' + currentUser.username)){
        alert(`Mentioned: ${msg.username}: ${msg.message}`);
      } else {
        alert(`New message from ${msg.username}: ${msg.message}`);
      }
      newMessageSound.play();
    }
  }
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

/* ==== PubNub Functions ==== */
function initializePubNub() {
  pubnub = new PubNub({
    publishKey: PUBLISH_KEY,
    subscribeKey: SUBSCRIBE_KEY,
    uuid: currentUser.username,
    secretKey: isAdmin ? SECRET_KEY : undefined // Only admin gets secret key for admin operations
  });

  // Add listener
  pubnub.addListener({
    message: function(messageEvent) {
      handleIncomingMessage(messageEvent.message);
    },
    status: function(statusEvent) {
      if (statusEvent.category === "PNConnectedCategory") {
        console.log("Connected to PubNub");
      }
    }
  });

  // Subscribe to channel
  pubnub.subscribe({
    channels: [CHANNEL_NAME]
  });
}

function publishMessage(messageData) {
  if (!pubnub) return;
  
  pubnub.publish({
    channel: CHANNEL_NAME,
    message: messageData
  }, function(status, response) {
    if (status.error) {
      console.error("Publish failed:", status);
      showNotifyBanner('Failed to send message');
    }
  });
}

function handleIncomingMessage(data) {
  // Handle system messages
  if(data.system === 'ban' && data.target){
    bannedUsers.add(data.target);
    saveLocalState();
    clearChatAndRenderAll();
    return;
  }
  if(data.system === 'unban' && data.target){
    bannedUsers.delete(data.target);
    saveLocalState();
    clearChatAndRenderAll();
    return;
  }
  if(data.system === 'notify' && data.text){
    showNotifyBanner(data.text);
    return;
  }

  const idx = messages.findIndex(m=>m.id === data.id);
  if(idx === -1){
    messages.push(data);
    saveLocalState();
    renderOneMessage(data,true);
  } else {
    messages[idx] = { ...messages[idx], ...data };
    saveLocalState();
    clearChatAndRenderAll();
  }
}

/* ==== Load History from PubNub ==== */
function loadHistory(){
  loadingDiv.style.display = 'flex';
  
  pubnub.fetchMessages({
    channels: [CHANNEL_NAME],
    count: 100
  }, (status, response) => {
    loadingDiv.style.display = 'none';
    
    if (status.error) {
      console.error('History fetch error:', status);
      return;
    }
    
    const channelMessages = response.channels[CHANNEL_NAME];
    if (channelMessages) {
      channelMessages.forEach(item => {
        const data = item.message;
        const idx = messages.findIndex(m=>m.id === data.id);
        if(idx === -1){
          messages.push(data);
        } else {
          messages[idx] = { ...messages[idx], ...data };
        }
      });
      saveLocalState();
      clearChatAndRenderAll();
    }
  });
}

/* ==== Load local state and initial render ==== */
loadLocalState();
if(localStorage.getItem('chatUser')){
  currentUser = JSON.parse(localStorage.getItem('chatUser'));
  // admin check saved
  if(currentUser.username === ADMIN_USERNAME && localStorage.getItem('lastPin') === ADMIN_PIN){
    isAdmin = true;
    adminBtn.style.display = 'inline-block';
  }
  pinOverlay.style.display = 'none';
  chatApp.style.display = 'flex';
  
  // Initialize PubNub after user is loaded
  initializePubNub();
  
  if(messages.length) messages.forEach(m => renderOneMessage(m,false));
  // Load history after PubNub is initialized
  setTimeout(() => loadHistory(), 1000);
}

/* ==== Send message ==== */
sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }});
function sendMessage(){
  const text = (messageInput.value || '').trim();
  if(!text || !currentUser) return;
  if(bannedUsers.has(currentUser.username)){
    showNotifyBanner('You are banned from sending messages.');
    return;
  }
  const id = makeId();
  const ts = formatTS();
  const msgObj = { id, username: currentUser.username, message: text, timestamp: ts, deleted: false };
  messages.push(msgObj);
  saveLocalState();
  renderOneMessage(msgObj,false);
  publishMessage(msgObj);
  messageInput.value = '';
}

/* ==== PIN login logic ==== */
pinBtn.addEventListener('click', ()=> {
  const username = (usernameInput.value || '').trim();
  const pin = (pinInput.value || '').trim();
  if(!username) return;
  // set user
  currentUser = { username };
  localStorage.setItem('chatUser', JSON.stringify(currentUser));
  // admin check
  if(username === ADMIN_USERNAME && pin === ADMIN_PIN){
    isAdmin = true;
    adminBtn.style.display = 'inline-block';
    localStorage.setItem('lastPin', ADMIN_PIN);
  } else {
    isAdmin = false;
    adminBtn.style.display = 'none';
    // save lastPin only for admin
    localStorage.removeItem('lastPin');
  }
  // regular pin check required to enter
  const allowedPin = (username === ADMIN_USERNAME && pin === ADMIN_PIN) ? ADMIN_PIN : PIN_CODE;
  if(pin !== allowedPin) {
    alert('Wrong PIN'); // minimal feedback
    // clear credentials saved if wrong
    localStorage.removeItem('chatUser');
    currentUser = null;
    return;
  }
  // proceed
  pinOverlay.style.display = 'none';
  chatApp.style.display = 'flex';
  
  // Initialize PubNub and load messages
  initializePubNub();
  loadLocalState();
  if(messages.length) clearChatAndRenderAll();
  setTimeout(() => loadHistory(), 1000);
});

/* ==== Admin modal toggle ==== */
adminBtn.addEventListener('click', ()=> {
  adminModal.style.display = adminModal.style.display === 'block' ? 'none' : 'block';
  adminModal.setAttribute('aria-hidden', adminModal.style.display === 'none');
});

/* ==== Admin actions ==== */
// delete by id
delByIdBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const id = (delIdInput.value||'').trim();
  if(!id) return showNotifyBanner('Provide id to delete.');
  const idx = messages.findIndex(m=>m.id===id);
  if(idx === -1) return showNotifyBanner('Message id not found.');
  messages[idx].deleted = true;
  saveLocalState();
  publishMessage({ ...messages[idx], deleted:true });
  clearChatAndRenderAll();
  showNotifyBanner('Message deleted.');
});
// delete all
deleteAllBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  if(!confirm('Confirm delete all messages for everyone?')) return;
  for(const msg of messages){ 
    msg.deleted = true; 
    publishMessage({ ...msg, deleted:true }); 
  }
  saveLocalState();
  clearChatAndRenderAll();
  showNotifyBanner('All messages deleted.');
});
// edit timestamp
editTsBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const id = (editIdInput.value||'').trim();
  const newTs = (editTsInput.value||'').trim();
  if(!id || !newTs) return showNotifyBanner('Provide id and new timestamp.');
  const idx = messages.findIndex(m=>m.id===id);
  if(idx === -1) return showNotifyBanner('Message id not found.');
  messages[idx].timestamp = newTs;
  saveLocalState();
  publishMessage({ ...messages[idx], timestamp:newTs });
  clearChatAndRenderAll();
  showNotifyBanner('Timestamp updated.');
});
// ban/unban
banBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const t = (banUserInput.value||'').trim();
  if(!t) return showNotifyBanner('Provide username to ban.');
  bannedUsers.add(t);
  saveLocalState();
  publishMessage({ id: makeId(), system:'ban', target: t });
  clearChatAndRenderAll();
  showNotifyBanner(`User ${t} banned.`);
});
unbanBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const t = (banUserInput.value||'').trim();
  if(!t) return showNotifyBanner('Provide username to unban.');
  bannedUsers.delete(t);
  saveLocalState();
  publishMessage({ id: makeId(), system:'unban', target: t });
  clearChatAndRenderAll();
  showNotifyBanner(`User ${t} unbanned.`);
});
// notify
notifyBtn.addEventListener('click', ()=> {
  if(!isAdmin) return;
  const txt = (notifyTextInput.value||'').trim();
  if(!txt) return showNotifyBanner('Provide notification text.');
  publishMessage({ id: makeId(), system:'notify', text: txt });
  showNotifyBanner('Notification sent.');
});

/* ==== Notifications (animated banner) ==== */
let bannerTimer = null;
function showNotifyBanner(text){
  notifyBanner.textContent = text + ' — please refresh to update';
  notifyBanner.style.display = 'block';
  if(bannerTimer) clearTimeout(bannerTimer);
  bannerTimer = setTimeout(()=> notifyBanner.style.display = 'none', 9000);
}

/* ==== Other UI controls ==== */
signoutBtn.addEventListener('click', ()=> { 
  if (pubnub) {
    pubnub.unsubscribeAll();
    pubnub.stop();
  }
  localStorage.removeItem('chatUser'); 
  localStorage.removeItem('lastPin'); 
  location.reload(); 
});

/* ==== Before unload: cleanup ==== */
window.addEventListener('beforeunload', ()=> {
  if (pubnub) {
    pubnub.unsubscribeAll();
  }
});

</script>
</body>
</html>
